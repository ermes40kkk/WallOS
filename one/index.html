<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Scanner</title>
  <style>
    body { font-family:sans-serif; background:#111; color:white;
           display:flex; flex-direction:column; align-items:center; }
    video { width:80%; max-width:800px; border:2px solid #333; margin:10px 0; }
    button {
      font-size: 2.3em !important;
       z-index: 8000;
    }
    ul#results {
      width: 340px;
      max-height: 60vh;
      position: fixed;
      right: 20px;
      top: 10%;
      overflow-y: auto;
      padding: 0;
      list-style: none;
      font-size: 2.2em;
      background: #222;
      border-radius: 8px;
      box-shadow: 0 2px 12px #000a;
      z-index: 2000;
      transition: opacity 0.2s;
    }
    ul#results.hide {
      opacity: 0;
      pointer-events: none;
    }
    li { background:#222; margin:5px 0; padding:8px 14px; border-radius:3px; }
    #debug-toggle {
      position: fixed;
      right: 20px;
      top: 7%;
      z-index: 2100;
      font-size: 2.1em;
      background: #333;
      color: #fff;
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      user-select: none;
    }
    #ocr-controls {
      position:fixed;
      right:20px;
      top:25%;
      background:#222;
      padding:12px 18px;
      border-radius:10px;
      z-index:9000;
    }
    #ocr-controls div {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <pre style="font-family:monospace; font-size:1.1em; color:#09ff00; margin-bottom:18px;">
 $$$$$$\                                                             
$$  __$$\                                                            
$$ /  \__| $$$$$$$\ $$$$$$\  $$$$$$$\  $$$$$$$\   $$$$$$\   $$$$$$\  
\$$$$$$\  $$  _____|\____$$\ $$  __$$\ $$  __$$\ $$  __$$\ $$  __$$\ 
 \____$$\ $$ /      $$$$$$$ |$$ |  $$ |$$ |  $$ |$$$$$$$$ |$$ |  \__|
$$\   $$ |$$ |     $$  __$$ |$$ |  $$ |$$ |  $$ |$$   ____|$$ |      
\$$$$$$  |\$$$$$$$\\$$$$$$$ |$$ |  $$ |$$ |  $$ |\$$$$$$$\ $$ |      
 \______/  \_______|\_______|\__|  \__|\__|  \__| \_______|\__|    
                                            Ermes40kkk 2024   
</pre>
  <!-- Sposta i pulsanti OCR sopra OCR FRAME -->
<button id="nummer-ocr-btn" style="
  position:fixed; right:40px; top:32%; transform:translateY(-50%);
  background:#ff9800; color:#fff; border:none; border-radius:8px; padding:12px 18px;
  font-size:2.3em; cursor:pointer; z-index:7002;">
  Nummer OCR
</button>
<button id="tabelle-ocr-btn" style="
  position:fixed; right:40px; top:36%; transform:translateY(-50%);
  background:#ffe600; color:#222; border:none; border-radius:8px; padding:12px 18px;
  font-size:1.3em; cursor:pointer; z-index:7002;">
  Tabelle OCR
</button>

  <button id="ocr-frame-btn" style="position:fixed; right:40px; top:40%; transform:translateY(-50%);
    background:#227; color:#fff; border:none; border-radius:8px; padding:12px 18px;
    font-size:2.3em; cursor:pointer; z-index:7001;">
    OCR Frame
  </button>
  <button id="send-frame-btn" style="position:fixed; right:40px; top:50%; transform:translateY(-50%);
    background:#2a2; color:#fff; border:none; border-radius:8px; padding:12px 18px;
    font-size:2.3em; cursor:pointer; z-index:7000;">
    Invia Frame
  </button>
  <label style="position:fixed; right:40px; top:60%; transform:translateY(-50%); z-index:1002; color:#fff;">
    <input type="checkbox" id="ocr-loop-switch" style="margin-right:8px;">
    OCR LOOP
  </label>
  <label id="debug-toggle">
    <input type="checkbox" id="debug-checkbox" checked style="margin-right:8px;">
    DEBUG
  </label>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" hidden></canvas>
  <ul id="results"></ul>


  <!-- Modifica posizione label Nummer: 30px sotto il video, a sinistra -->
  <div id="nummer-label" style="
    position:fixed; left:20px; top:1330px; background:#222; color:#fff;
    border-radius:8px; padding:10px 18px; font-size:2.3em; z-index:9001;">
    Nummer: <span id="nummer-val"></span> <span id="nummer-found"></span>
  </div>

  <!-- Pulsante SETTING in alto a destra -->
<button id="settings-btn" style="
  position:fixed; right:20px; top:7%; z-index:2200; font-size:2.1em;
  background: #444; color: #fff; border-radius: 6px; padding: 6px 18px; cursor: pointer;">
  SETTING
</button>

<!-- Finestra di settings nascosta di default -->
<div id="settings-modal" style="
  display:none; position:fixed; right:40px; top:12%; z-index:2300; background:#222;
  color:#fff; border-radius:12px; padding:22px 28px; box-shadow:0 2px 16px #000a; min-width:320px;">
  <label style="font-size:1.1em;">
    <input type="checkbox" id="debug-checkbox-modal" checked style="margin-right:8px;">
    DEBUG
  </label>
  <hr style="margin:12px 0;">
  <div style="margin-bottom:10px;">
    <strong>Nummer Parametri</strong><br>
    Riga <button id="rigaNummer-minus">-</button>
    <span id="rigaNummer-val">1</span>
    <button id="rigaNummer-plus">+</button>
    &nbsp; Col <button id="collNummer-minus">-</button>
    <span id="collNummer-val">1</span>
    <button id="collNummer-plus">+</button>
  </div>
  <div>
    <strong>Tabelle Parametri</strong><br>
    Riga <button id="rigaTabelle-minus">-</button>
    <span id="rigaTabelle-val">2</span>
    <button id="rigaTabelle-plus">+</button>
    &nbsp; Col1 <button id="coll1Tabella-minus">-</button>
    <span id="coll1Tabella-val">1</span>
    <button id="coll1Tabella-plus">+</button>
    &nbsp; Col2 <button id="coll2Tabella-minus">-</button>
    <span id="coll2Tabella-val">2</span>
    <button id="coll2Tabella-plus">+</button>
    &nbsp; Max <button id="maxTabelle-minus">-</button>
    <span id="maxTabelle-val">5</span>
    <button id="maxTabelle-plus">+</button>
  </div>
 </div>

  <!-- Visualizzazione magazzino sotto nummer-label -->
<div id="magazzino-view" style="
  position:fixed; left:20px; top:1430px; 
  background:#181818; padding:18px 12px; border-radius:12px; 
  z-index:9000; display:flex; flex-direction:column;">

  <div style="display:flex; flex-direction:row; gap:12px;">
    <!-- Genera 40 colonne -->
    <div style="display:flex; flex-direction:row; gap:18px;">
      <!-- Gruppi di 2 colonne con spazio tra i gruppi -->
      <!-- Ogni gruppo -->
      <!-- JS genererÃ  i quadratini -->
      <div id="magazzino-matrix" style="display:flex; flex-direction:row; gap:18px;"></div>
    </div>
  </div>
</div>

  <!-- librerie -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const resultsList = document.getElementById("results");
    const debugCheckbox = document.getElementById("debug-checkbox");

    const codiciLetti = new Set();
    let counter = 1;

    function aggiungiCodice(codice) {
      if (!codiciLetti.has(codice)) {
        codiciLetti.add(codice);
        const li = document.createElement("li");
        li.textContent = codice;
        resultsList.prepend(li);
      }
    }

    // Avvia fotocamera
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => {
        video.srcObject = stream;
        startQRScanner();
        startBarcodeScanner();
        // startPlateScanner();
      })
      .catch(err => alert("Errore: " + err.message));

    let nummerVal = ""; // valore corrente Nummer

function setNummerVal(val, gefunden = false) {
  nummerVal = val;
  document.getElementById("nummer-val").textContent = val;
  const foundSpan = document.getElementById("nummer-found");
  if (gefunden) {
    foundSpan.innerHTML = '<span style="color:#0f0;font-weight:bold;">GEFUNDEN</span>';
  } else {
    foundSpan.innerHTML = '';
  }
}

// OCR Nummer
document.getElementById("nummer-ocr-btn").onclick = () => {
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  canvas.toBlob(blob => {
    Tesseract.recognize(blob, 'eng').then(({ data: { text } }) => {
      const lines = text.split(/\n/).map(l => l.trim()).filter(Boolean);
      const line = lines[params.rigaNummer-1] || "";
      const cols = line.split(/\s+/);
      const val = cols[params.collNummer-1] || "";
      setNummerVal(val, false); // aggiorna label, nessun trovato
      aggiungiCodice(`Nummer: ${val}`);
    });
  }, "image/jpeg");
};

// QR scanner
function startQRScanner() {
  video.addEventListener("play", () => {
    const scan = () => {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imgData.data, canvas.width, canvas.height);
        if (code) {
          let gefunden = false;
          let found = "";
          if (nummerVal && code.data.includes(nummerVal)) {
            gefunden = true;
            found = ' <span style="color:#0f0;font-weight:bold;">GEFUNDEN</span>';
            setNummerVal(nummerVal, true);
          } else {
            setNummerVal(nummerVal, false);
          }
          const li = document.createElement("li");
          li.innerHTML = `QR ${counter++}: ${code.data}${found}`;
          resultsList.prepend(li);
        }
      }
      requestAnimationFrame(scan);
    };
    scan();
  });
}

// Barcode scanner
function startBarcodeScanner() {
  Quagga.init({
    inputStream: {
      type: "LiveStream",
      target: video,
      constraints: { facingMode: "environment" }
    },
    decoder: {
      readers: ["code_128_reader","ean_reader","ean_8_reader",
                "code_39_reader","upc_reader","upc_e_reader"]
    },
    locate: true
  }, err => { if (!err) Quagga.start(); });

  Quagga.onDetected(d => {
    let gefunden = false;
    let found = "";
    if (nummerVal && d.codeResult.code.includes(nummerVal)) {
      gefunden = true;
      found = ' <span style="color:#0f0;font-weight:bold;">GEFUNDEN</span>';
      setNummerVal(nummerVal, true);
    } else {
      setNummerVal(nummerVal, false);
    }
    const li = document.createElement("li");
    li.innerHTML = `Barcode ${counter++}: ${d.codeResult.code}${found}`;
    resultsList.prepend(li);
  });
}

// Lettura targhe con OCR
    async function startPlateScanner() {
      const worker = await Tesseract.createWorker('eng', 1);
      const plateRegex = /^[A-Z]{1,3}\s?[0-9]{1,4}\s?[A-Z]{0,2}$/i; // esempio EU

      const loop = async () => {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const { data: { text } } = await worker.recognize(canvas);
          const lines = text.split(/\n/).map(l => l.trim()).filter(Boolean);

          for (const line of lines) {
            // if (plateRegex.test(line)) {
              aggiungiCodice("Targa " + counter++ + ": " + line);
            // }
          }
        }
        setTimeout(loop, 3000); // OCR ogni 3s per non sovraccaricare
      };
      loop();
    }

    
    async function inviaAlServer(imgBlob) {
  const form = new FormData();
  form.append("frame", imgBlob, "frame.jpg");

  const resp = await fetch("https://camera.mossino.eu/api/lpr/recognize", {
    method: "POST",
    body: form
  });
  return await resp.text();
}

const sendFrameBtn = document.getElementById("send-frame-btn");
sendFrameBtn.addEventListener("click", async () => {
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  canvas.toBlob(async blob => {
    const testo = await inviaAlServer(blob);
    aggiungiCodice("Server: " + testo);
  }, "image/jpeg");
});

const ocrFrameBtn = document.getElementById("ocr-frame-btn");
ocrFrameBtn.addEventListener("click", () => {
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  canvas.toBlob(blob => {
    Tesseract.recognize(
      blob,
      'eng',
      {
        logger: info => console.log(info)
      }
    ).then(({ data: { text } }) => {
      const lines = text.split(/\n/).map(l => l.trim()).filter(Boolean);
      lines.forEach(line => aggiungiCodice("OCR: " + line));
    });
  }, "image/jpeg");
});

const ocrLoopSwitch = document.getElementById("ocr-loop-switch");
let ocrLoopActive = false;
ocrLoopSwitch.addEventListener("change", () => {
  ocrLoopActive = ocrLoopSwitch.checked;
  if (ocrLoopActive) startPlateScanner();
  else Tesseract.terminate();
});

debugCheckbox.addEventListener("change", () => {
      if (debugCheckbox.checked) {
        resultsList.classList.remove("hide");
      } else {
        resultsList.classList.add("hide");
      }
    });

    // Parametri iniziali
const params = {
  rigaNummer: 1,
  collNummer: 1,
  rigaTabelle: 2,
  coll1Tabella: 1,
  coll2Tabella: 2,
  maxTabelle: 5
};

function updateParamsUI() {
  document.getElementById("rigaNummer-val").textContent = params.rigaNummer;
  document.getElementById("collNummer-val").textContent = params.collNummer;
  document.getElementById("rigaTabelle-val").textContent = params.rigaTabelle;
  document.getElementById("coll1Tabella-val").textContent = params.coll1Tabella;
  document.getElementById("coll2Tabella-val").textContent = params.coll2Tabella;
  document.getElementById("maxTabelle-val").textContent = params.maxTabelle;
}
updateParamsUI();

["rigaNummer","collNummer","rigaTabelle","coll1Tabella","coll2Tabella","maxTabelle"].forEach(param => {
  document.getElementById(param+"-plus").onclick = () => { 
    params[param]++; 
    updateParamsUI(); 
  };
  document.getElementById(param+"-minus").onclick = () => { 
    if(params[param]>1) params[param]--; 
    updateParamsUI(); 
  };
});

// OCR Nummer
document.getElementById("nummer-ocr-btn").onclick = () => {
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  canvas.toBlob(blob => {
    Tesseract.recognize(blob, 'eng').then(({ data: { text } }) => {
      const lines = text.split(/\n/).map(l => l.trim()).filter(Boolean);
      const line = lines[params.rigaNummer-1] || "";
      const cols = line.split(/\s+/);
      const val = cols[params.collNummer-1] || "";
      setNummerVal(val, false); // aggiorna label, nessun trovato
      aggiungiCodice(`Nummer: ${val}`);
    });
  }, "image/jpeg");
};

// OCR Tabelle
document.getElementById("tabelle-ocr-btn").onclick = () => {
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  canvas.toBlob(blob => {
    Tesseract.recognize(blob, 'eng').then(({ data: { text } }) => {
      const lines = text.split(/\n/).map(l => l.trim()).filter(Boolean);
      for(let i=0; i<params.maxTabelle; i++) {
        const line = lines[params.rigaTabelle-1+i] || "";
        const cols = line.split(/\s+/);
        const v1 = cols[params.coll1Tabella-1] || "";
        const v2 = cols[params.coll2Tabella-1] || "";
        if(v1 || v2) aggiungiCodice(`Tabella: ${v1} | ${v2}`);
      }
    });
  }, "image/jpeg");
};

// Gestione apertura/chiusura settings
const settingsBtn = document.getElementById("settings-btn");
const settingsModal = document.getElementById("settings-modal");

settingsBtn.onclick = () => {
  if (settingsModal.style.display === "block") {
    settingsModal.style.display = "none";
  } else {
    settingsModal.style.display = "block";

  }
};
const magazzinoMatrix = document.getElementById("magazzino-matrix");

// Matrice per posizioni trovate
let magazzinoData = Array.from({length: 40}, () => Array(18).fill(false));

// Funzione per aggiornare la visualizzazione magazzino
function aggiornaMagazzinoView() {
  // Rimuovi tutto
  magazzinoMatrix.innerHTML = "";
  for (let group = 0; group < 20; group++) {
    const groupDiv = document.createElement("div");
    groupDiv.style.display = "flex";
    groupDiv.style.flexDirection = "row";
    groupDiv.style.gap = "4px";
    for (let col = 0; col < 2; col++) {
      const colNum = group * 2 + col + 1;
      const colDiv = document.createElement("div");
      colDiv.style.display = "flex";
      colDiv.style.flexDirection = "column";
      colDiv.style.gap = "2px";
      const label = document.createElement("div");
      label.textContent = colNum;
      label.style.textAlign = "center";
      label.style.color = "#ffe600";
      label.style.fontWeight = "bold";
      label.style.marginBottom = "2px";
      colDiv.appendChild(label);
      for (let row = 1; row <= 18; row++) {
        const cell = document.createElement("div");
        cell.style.width = "18px";
        cell.style.height = "18px";
        cell.style.background = magazzinoData[colNum-1][row-1] ? "#0f0" : "#333";
        cell.style.border = "1px solid #555";
        cell.style.borderRadius = "4px";
        cell.style.marginBottom = "2px";
        cell.title = `Colonna ${colNum}, Posizione ${row}`;
        colDiv.appendChild(cell);
      }
      groupDiv.appendChild(colDiv);
    }
    groupDiv.style.marginRight = "12px";
    magazzinoMatrix.appendChild(groupDiv);
  }
}

// OCR Tabelle modificato: salva v1/v2 nella matrice e aggiorna la vista
document.getElementById("tabelle-ocr-btn").onclick = () => {
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  canvas.toBlob(blob => {
    Tesseract.recognize(blob, 'eng').then(({ data: { text } }) => {
      const lines = text.split(/\n/).map(l => l.trim()).filter(Boolean);
      for(let i=0; i<params.maxTabelle; i++) {
        const line = lines[params.rigaTabelle-1+i] || "";
        const cols = line.split(/\s+/);
        let v1 = cols[params.coll1Tabella-1] || "";
        let v2 = cols[params.coll2Tabella-1] || "";
        // Caso: v1 ha 4 caratteri, aggregato
        if (v1.length === 4 && /^\d{4}$/.test(v1)) {
          // Primi 2 caratteri = colonna, ultimi 2 = riga
          let col = parseInt(v1.slice(0,2), 10);
          let row = parseInt(v1.slice(2,4), 10);
          if (col >= 1 && col <= 40 && row >= 1 && row <= 18) {
            magazzinoData[col-1][row-1] = true;
          }
        } else {
          // v1 e v2 separati, screma "01"->1, "04"->4
          let col = v1.length ? parseInt(v1, 10) : NaN;
          let row = v2.length ? parseInt(v2, 10) : NaN;
          if (!isNaN(col) && !isNaN(row) && col >= 1 && col <= 40 && row >= 1 && row <= 18) {
            magazzinoData[col-1][row-1] = true;
          }
        }
        if(v1 || v2) aggiungiCodice(`Tabella: ${v1} | ${v2}`);
      }
      aggiornaMagazzinoView();
    });
  }, "image/jpeg");
};

// Inizializza la vista magazzino all'avvio
aggiornaMagazzinoView();
  </script>

</body>
</html>
